<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="viewport">
    <title>Thermostat Control Red River Drive</title>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>	
	<script type="text/javascript" src="/webiopi.js"></script>
	<script type="text/javascript">
        // declare few global variables
        var tmp;
        var mcp;
        var heater = 17;
		var fan = 27;
		var ac = 22;
		var chart;
		var currenttemp = 0;
		var programlength = 0; 
		var sensorlookup = ["Living Room", "Bedroom", "Basement" ];
		
        webiopi().ready(init);
        
        // defines function passed to webiopi().ready()
 

		function init() {
                // setup helpers to remotely control devices  
				tmp = new Temperature("bmp");				

				// initialize program display select boxes
				var s = $('#pg_time_hr').empty()[0];
				for (var i = 0; i < 24; i++) {					
					s[i] = new Option(i, i);
					}
				s = $('#pg_time_min').empty()[0];
				for (var i = 0; i < 60; i++) {				
					s[i] = new Option(i, i);
					}

				s = $('#pg_temp').empty()[0];
				for (var i = 0; i < 40; i++) {				
					s[i] = new Option(i, i);
					}
					
				prg_display_index(0);


				
                // automatically refresh UI each seconds
                setInterval(updateUI, 1000);
				//webiopi().setFunction(heater, "OUT")		
				//webiopi().setFunction(ac, "OUT")		
				webiopi().callMacro("getCurrentState", [], updateThermDisplay);	
				
				


				// Pre load chart and set update interval
				//webiopi().callMacro("send_graph_data", [], chart_fill);	
				//setInterval(updateChart, 3000);			
			
        }

        // function called through setInterval
        function updateUI() {
                // call Temperature.getCelsius REST API
                // result is asynchronously displayed using the callback
				//tmp.getCelsius(temperatureCallback);    
  
				webiopi().digitalRead(heater, gpioPortDigitalCallback);
				webiopi().digitalRead(ac, gpioPortDigitalCallback);
				
                // call getMode macro
                webiopi().callMacro("getMode", [], modeCallback);
				webiopi().callMacro("getCurrentState", [], updateThermDisplay);
				
							
        }       

        // callback function used to display the temperature
/*        function temperatureCallback(sensorName, data) {                
				// jQuery functions
				currenttemp = parseFloat(data);
                $("#bt_tempDisplay").text(data + " C");
        }*/
        
        // callback function used to display MCP digital state
		// Don't know why the fuck this needs to be called but IO won't update if it's left out... 
        function gpioPortDigitalCallback(gpioName, channel, value) {
        }

        // callback function used to display current heater mode
        function modeCallback(macroName, args, data) {
                $("#bt_mode").text(data);
        }
		
		function setCallback(macroName, args, data) {
				//$("#bt_mode").text(data);
        }
		

		

		
        var updateThermDisplay = function(macro, args, response) {
                    var data = response.split(";");
                    var heaterOut = webiopi().digitalRead(heater);
					var acOut = webiopi().digitalRead(ac);
					
					if (heaterOut == "1") {
                        // jQuery functions
                        $("#bt_heater").attr("class", "OFF");
						$("#bt_heater").text("Heater OFF");
					}
					else if (heaterOut == "0") {
                        $("#bt_heater").attr("class", "ON");
						$("#bt_heater").text("Heater ON");
					}
					
					if (acOut == "1") {
                        // jQuery functions
                        $("#bt_ac").attr("class", "OFF");
						$("#bt_ac").text("AC OFF");
					}
					else if (acOut == "0") {
                        $("#bt_ac").attr("class", "ACON");
						$("#bt_ac").text("AC ON");
					}		
					
					if(data[4] == "0"){
						$("#bt_fanstate").attr("class", "OFF");
						$("#bt_fanstate").text("Fan OFF ");						
						}
					else{
						$("#bt_fanstate").attr("class", "FANON");
						$("#bt_fanstate").text("Fan ON ");	
						}						
												
					
                    $("#dispTime").val(data[0]+":"+data[1]);
					//$("#dispSensor").val(data[2]);
					$("#bt_sensorid").text(data[2]);
					$("#dispTempSet").val(data[3]);
					$("#dispFan").val(data[4]);		
					$("#dispExp").val(data[5]);	
					//$("#bt_tempDisplay").text(data[7] + " C");
					
					if(data[5] == "No override"){
						$("#bt_override").attr("class", "OFF");
						$("#bt_override").text(" ");						
						$("#temp_setpoint").text(data[3]);	
						}
					else{
						$("#bt_override").attr("class", "ON");
						$("#bt_override").text(data[5]);
						$("#temp_setpoint").text(data[6]);	
						}					
			
					if(data[2] == sensorlookup[1]){
						$("#bt_LocalTemp").attr("class", "DEF");
						$("#bt_RemTemp1").attr("class", "SENON");
						$("#bt_RemTemp2").attr("class", "DEF");
					}	
					if(data[2] == sensorlookup[2]){
						$("#bt_LocalTemp").attr("class", "DEF");
						$("#bt_RemTemp1").attr("class", "DEF");
						$("#bt_RemTemp2").attr("class", "SENON");
					}
					else{
						$("#bt_LocalTemp").attr("class", "SENON");
						$("#bt_RemTemp1").attr("class", "DEF");
						$("#bt_RemTemp2").attr("class", "DEF");
					}					
						
					$("#bt_LocalTemp").text(data[8] + " C");
					$("#bt_RemTemp1").text(data[9] + " C");
					$("#bt_RemTemp2").text(data[10] + " C");
					$("#bt_LocalTemp2").text(data[11] + " C");
					var hum = (parseFloat(data[12]) * 100);					
					$("#bt_LocalHum").text(hum.toFixed(2) + "%");
					var press = ((parseFloat(data[13]) + 4100) / 1000);
					$("#bt_LocalPress").text(press.toFixed(2) + "kPa");
					
					
                }

		function fan_override(){
			
			webiopi().callMacro("fan_change", $("#overridetime").val());
		}
		function toggleMode(){			
				webiopi().callMacro("setMode");				
		}
		
		function temp_up() {				
				var tempchange = ["1", $("#overridetime").val()];
				webiopi().callMacro("temp_change", tempchange);
		}
		
		function temp_down() {		
				var tempchange = ["-1", $("#overridetime").val()];		
				webiopi().callMacro("temp_change", tempchange);
		}

			function pg_prev(){
				prg_display_index(parseInt($("#pg_index").val())-1);			
			}

			
			function pg_next(){
				prg_display_index(parseInt($("#pg_index").val())+1);
			}
				
			function pg_sensorlookup(){
					$("#pg_sensor").val(sensorlookup[parseInt($("#pg_sensor").val())]);
					//$("#pg_sensor").val(sensorlookup[1]);
					
			}
				
			function pg_new(){
				$("#pg_index").val(programlength);					
			}

			function pg_save(){
				var Tstring = $("#pg_time_hr").val() + ":" + $("#pg_time_min").val();
				var prgtoadd = [$("#pg_index").val(), Tstring, $("#pg_sensor").val(), $("#pg_temp").val(), $("#pg_fanon").val() ]			
				webiopi().callMacro("setProgram", prgtoadd);			
			
			}
			
			function clear_or(){
				webiopi().callMacro("clearOverride");
			}
		
		
			function prg_display_index(index){
				webiopi().callMacro("getProgram", index, prg_display_callback);		
		
			}
		
			function prg_display_callback(macro, args, response){
				var data = response.split(";");					
				$("#pg_time_hr").val(parseInt(data[0]));			
				$("#pg_time_min").val(parseInt(data[1]));
				$("#pg_sensor").val(parseInt(data[2]));
				$("#pg_temp").val(parseInt(data[3]));		
				$("#pg_fanon").val(parseInt(data[4]));		
				$("#pg_index").val(parseInt(data[6]));	
				$("#pg_textSensor").val(sensorlookup[ parseInt(data[2])]);	
				programlength = parseInt(data[5]);
			}		



			// Charting code starts here

		
		
        
   </script>   
   	<script type="text/javascript">    
        
	
	</script>
   
           <style type="text/css">
                button {
                        display: block;
                        margin: 5px 5px 5px 5px;
                        width: 170px;
                        height: 45px;
                        font-size: 24pt;
                        font-weight: bold;
                        color: gray;
                }
                
				button.DEF {
                        display: block;
                        margin: 5px 5px 5px 5px;
                        width: 170px;
                        height: 45px;
                        font-size: 24pt;
                        font-weight: bold;
                        color: gray;

                }
				
				button.SENON {
                        background-color: gray;
						color: SlateBlue;
                }
				
                button.OFF {
                        background-color: Black;
						font-size: 16pt;
                }
                
                button.ON {
                        background-color: Red;
						color: black;
						font-size: 16pt;
                }
				
				button.ACON {
						font-size: 16pt;						
						color: black;
						background-color: Blue;
				}
				
				button.FANON {
						font-size: 16pt;						
						color: black;
						background-color: Green;
				}
				

				button.SEN {
						font-size: 12pt;						
						color: black;
						background-color: Grey;
				}

				
        </style>
</head>
<body>
    <div align="center">
	<table style="width:30%">
		<tr>
				<th colspan="3">Status</th>
		</tr>
		<tr>
				<td><button id="bt_heater"/> </td>				
				<td><button id="bt_fanstate" onclick="fan_override()"/></td>
				<td><button id="bt_ac"/></td>
		</tr>
		<tr>
<!-- 				<th>Active Sensor</th>
				<th>Temperature</th> -->
				<th></th>
				<th>Mode</th>
				<th></th>
		</tr>		
		<tr>
<!-- 				<td><button id="bt_sensorid" class="SEN"/></td>
				<td><button id="bt_tempDisplay"/></td> -->
				<td></td>
				<td><button id="bt_mode" onclick="toggleMode()"/></td>
				<td></td>
		</tr>
		<tr>
				<th>Living Room</th>
				<th>Bedroom</th>
				<th>Basement</th>		

		</tr>		
		<tr>
				<td><button id="bt_LocalTemp"/></td>
				<td><button id="bt_RemTemp1"/></td>
				<td><button id="bt_RemTemp2"/></td>	
		</tr>
		

		
		<tr>
			<th> Override </th>
			<th> Temp Set Point </th>
			<th> Override </th>
		</tr>
		<tr>								
				<td><button id="temp_up" onclick="temp_up()">UP</button></td>
				<td><button id="temp_setpoint"/></td>
				<td><button id="temp_down" onclick="temp_down()">DOWN</button></td>
		</tr>
		<tr>
				<th> </th>
				<th>Outside</th>
				<th> </th>		

		</tr>		
		<tr>
				<td><button id="bt_LocalHum"/></td>
				<td><button id="bt_LocalTemp2"/></td>
				<td><button id="bt_LocalPress"/></td>
		</tr>
		<tr>
				<th>Select Override Length</th>
				<th></th>				
				<th>Overide expiry</th>				
		</tr>	
		<tr>	
		<td align="center">
				<select id="overridetime">
				<option value="30">30 Mins</option>
				<option value="1">1 Mins</option>
				<option value="10">10 Mins</option>				
				<option value="60">1 Hour</option>
				<option value="120">2 Hours</option>
				<option value="240">4 Hours</option>
				</select>
			</td>
				
				<td align="center"><button id="bt_ORClear" onclick="clear_or()"">Clear Override</button></td>
				<td align="center"><button id="bt_override"/></td>
				<td align="center"/>

				
														
		</tr>
		</table>
		<table border="1" style="width:30%">
		<tr>
				<th colspan="2">Current Program Data</th>
		</tr>
		
		<tr>
				<td>Time :</td>	<td><input type="text" id="dispTime" /></td>
		</tr>
		<tr>
				<td>Active Sensor : </td><td><input type="text" id="dispSensor" /></td>
		</tr>
		<tr>
				<td>Temp Set Point : </td><td><input type="text" id="dispTempSet" /></td>
		</tr>
		<tr>
				<td>Fan State : </td><td><input type="text" id="dispFan" /></td>
		</tr>
		<tr>	
				<td>Override expiring in : </td><td><input type="text" id="dispExp" /></td>
		</tr>
		<tr>	
				<td>Debug Data : </td><td><input type="text" id="debugDisp" /></td>
		</tr>
		
	</table>
	
		<table border="1" style="width:30%">
		<tr>
				<th colspan="2">Edit Program Data</th>
		</tr>
		<tr>
				<td>Temp Set Point : </td><td>				
				<select id="pg_temp">
				<option value="10">10</option>
				</select>
				</td>
		</tr>
		<tr>
				<td>Time :</td>	
				<td>				
				<select id="pg_time_hr">			
				<option value="10">10</option>
				</select>				
				<select id="pg_time_min">		
				<option value="10">10</option>				
				</select>
				</td>							
		</tr>
		<tr>
				<td>Active Sensor : </td><td>
				<select id="pg_sensor" onchange="pg_sensorlookup">
				<option value="0">Living Room</option>
				<option value="1">Bedroom</option>
				<option value="2">Basement</option>
				</select>
				</td>
		</tr>

		<tr>
				<td>Fan State : </td>
				<td>				
				<select id="pg_fanon">
				<option value="0">Off</option>
				<option value="1">On</option>				
				</select></td>
		</tr>
		<tr>
				
				<td>Program Index :</td>	<td><input type="text" id="pg_index" /></td>
		</tr>

		<tr>	
				<td>Debug Data : </td><td><input type="text" id="pg_debugDisp" /></td>
		</tr>
		<tr>								
				<td align="center"><button id="pg_bt_prev" onclick="pg_prev()">PREV</button></td>
				<td align="center"><button id="pg_bt_next" onclick="pg_next()">NEXT</button></td>
		</tr>
		<tr>
				<td align="center"><button id="pg_bt_new" onclick="pg_new()">New</button></td>
				<td align="center"><button id="pg_bt_save" onclick="pg_save()">Save</button></td>
		</tr>
	</table>

	
    </div>
</body>
</html>

   