
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Speedometer</title>
    <link rel='stylesheet' href='http://fonts.googleapis.com/css?family=Play:700,400' type='text/css'>
    
    <script type="text/javascript" src="http://iop.io/js/vendor/d3.v3.min.js"></script>
    <script type="text/javascript" src="http://iop.io/js/vendor/polymer/PointerEvents/pointerevents.js"></script>
    <script type="text/javascript" src="http://iop.io/js/vendor/polymer/PointerGestures/pointergestures.js"></script>
    <script type="text/javascript" src="http://iop.io/js/iopctrl.js"></script>
    
    <style>
        body {
            font: 16px arial;
            background-color: #515151;
        }
		#speedometer_container {
			/*line-height:30px;*/
			/*background-color:#eeeeee;*/
			/*height:300px;*/
			width:360px;
			float:left;
			padding:5px; 
		}
		
        .unselectable {
            -moz-user-select: -moz-none;
            -khtml-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* css formats for the gauge */
        .gauge .domain {
            stroke-width: 2px;
            stroke: #fff;
        }

        .gauge .tick line {
            stroke: #fff;
            stroke-width: 2px;
        }
        
        .gauge line {
            stroke: #fff;
        }

        .gauge .arc, .gauge .cursor {
            opacity: 0;
        }

        .gauge .major {
            fill: #fff;
            font-size: 10px;
            font-family: 'Play', verdana, sans-serif;
            font-weight: normal;
        }
        
        .gauge .indicator {
            stroke: #EE3311;
            fill: #000;
            stroke-width: 4px;
        }

        /* css formats for the segment display */
        .segdisplay .on {
            fill: #00FFFF;

        }

        .segdisplay .off {
            fill: #00FFFF;
            opacity: 0.15;
        }
    </style>
	<link type="text/css" rel="stylesheet" href="buttons.css">
</head>
<body>
    <div id="speedometer_container">
  <!--      <span id="speedometer"></span> -->
    </div>
	    <div align="center">
	<table style="width:30%">
		<tr>
				<th colspan="3">Status</th>
		</tr>
		<tr>
				<td><button id="bt_heater" class="button blue medium"/> </td>				
				<td><button id="bt_fanstate" class="button blue bigrounded"/></td>
				<td><button  id="bt_acstate" class="button blue bigrounded"/></td>
		</tr>
		<tr>
<!-- 				<th>Active Sensor</th>
				<th>Temperature</th> -->
				<th></th>
				<th>Mode</th>
				<th></th>
		</tr>		
		<tr>
<!-- 				<td><button id="bt_sensorid" class="SEN"/></td>
				<td><button id="bt_tempDisplay"/></td> -->
				<td></td>
				<td><button id="bt_mode" /></td>
				<td></td>
		</tr>
		<tr>
				<td><button id="bt_LocalTemp"/></td>
				<td><button id="bt_RemTemp1"/></td>
				<td><button id="bt_RemTemp2"/></td>	
		</tr>
		

		
		<tr>
			<th> Override </th>
			<th> Temp Set Point </th>
			<th> Override </th>
		</tr>
		<tr>								
				<td><button id="temp_up" >UP</button></td>
				<td><button id="temp_setpoint"/></td>
				<td><button id="temp_down" >DOWN</button></td>
		</tr>
		<tr>
				<th></th>
				<th>Outside</th>
				<th> </th>		

		</tr>		
		<tr>
				<th>Humidity</th>
				<th>Temp</th>
				<th>Pressure</th>		

		</tr>		
		<tr>
				<td><button id="bt_LocalHum"/></td>
				<td><button id="bt_LocalTemp2"/></td>
				<td><button id="bt_LocalPress"/></td>
		</tr>
		</div>
		
		
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script>

/*        var svg = d3.select("#speedometer")
                .append("svg:svg")
                .attr("width", 400)
                .attr("height", 400);


        var gauge = iopctrl.arcslider()
                .radius(120)
                .events(false)
                .indicator(iopctrl.defaultGaugeIndicator);
        gauge.axis().orient("in")
                .normalize(true)
                .ticks(12)
                .tickSubdivide(3)
                .tickSize(10, 8, 10)
                .tickPadding(5)
                .scale(d3.scale.linear()
                        .domain([0, 160])
                        .range([-3*Math.PI/4, 3*Math.PI/4]));

        var segDisplay = iopctrl.segdisplay()
                .width(80)
                .digitCount(6)
                .negative(false)
                .decimals(0);

        svg.append("g")
                .attr("class", "segdisplay")
                .attr("transform", "translate(130, 200)")
                .call(segDisplay);

        svg.append("g")
                .attr("class", "gauge")
                .call(gauge);

        segDisplay.value(56749);        
		gauge.value(92);*/
		
		var gauge = [];
		var segDisplay = [];
		var Sparams = 0;
		
		get_sparams();
		//CreateTempGauges();
		setTimeout( CreateTempGauges, 500 );
		setInterval(UpdateUI, 1000);
		
		function get_sparams(){
			
			var oReq = new XMLHttpRequest(); //New request object
			oReq.onload = function() {				
				Sparams = JSON.parse(this.responseText)
				}
		
			oReq.open("get", "thermostat_interface.php", true);
			oReq.send();
	
		}
		
		function CreateTempGauges(){
			
			var i  = 0;				
			for (var key in Sparams){
				var sensorbatch = Sparams[key]
				for (var sensors in sensorbatch){							
					sensorobj = sensorbatch[sensors]					
					if (!sensorobj.hasOwnProperty('read_successful')) continue;		
					divname = sensors.replace(/\s+/g, '');
					//alert(JSON.stringify(sensorobj));
					//alert(JSON.stringify(sensors));
					var gaugediv = document.createElement(divname);
					document.getElementById('speedometer_container').appendChild(gaugediv);
			
					var svg = d3.select(divname)
						.append("svg:svg")
						.attr("width", 180)
						.attr("height", 180);

					gauge[i] = iopctrl.arcslider()
							.radius(60)
							.events(false)
							.indicator(iopctrl.defaultGaugeIndicator);
							
					gauge[i].axis().orient("in")
							.normalize(true)
							.ticks(12)
							.tickSubdivide(3)
							.tickSize(10, 8, 10)
							.tickPadding(5)
							.scale(d3.scale.linear()
									.domain([-40, 40])
									.range([-3*Math.PI/4, 3*Math.PI/4]));

					segDisplay[i] = iopctrl.segdisplay()
							.width(80)
							.digitCount(5)
							.negative(true)
							.decimals(2);

					svg.append("g")
							.attr("class", "segdisplay")
							.attr("transform", "translate(70, 155)")
							.call(segDisplay[i]);

					gg = svg.append("g")
							.attr("class", "gauge")
							.call(gauge[i]);
					
					gg.append("text")
						.attr("x", 10 )
						.attr("y", 30)
						.attr("dy", ".35em")
						.text(sensors);

					
					segDisplay[i].value(sensorobj['temperature']);						
					gauge[i].value(sensorobj['temperature']);										
					i++;
					}
			}
		}

		
		
		
		
		
		function UpdateUI(){
			get_sparams();
			var i  = 0;				
			
			// Block for updating temperature sensor gauges
			for (var key in Sparams){
				var sensorbatch = Sparams[key]
				for (var sensors in sensorbatch){							
					sensorobj = sensorbatch[sensors]					
					if (!sensorobj.hasOwnProperty('read_successful')) continue;		
					divname = sensors.replace(/\s+/g, '');
					//alert(JSON.stringify(sensorobj));
					//alert(JSON.stringify(sensors));
					//var gaugediv = document.createElement(divname);
					//document.getElementById('speedometer_container').appendChild(gaugediv);
					//gaugeobj = d3.select("#" + divname);
					//alert(JSON.stringify(gaugeobj));
					segDisplay[i].value(sensorobj['temperature']);						
					gauge[i].value(sensorobj['temperature']);										
					i++;	
				
				
				
				}
		
		
			}
		}
		
    
    </script>
</body></head>
</html>
